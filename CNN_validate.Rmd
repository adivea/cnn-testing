---
title: "CNN_validate"
author: "Adela Sobotkova"
date: "13/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r libraries}
library(tidyverse)
library(sf)
library(raster)
```

## Load Data

### Background image
```{r sat-img}
# Load the merged Satellite image for Kazanlak Valley, Bulgaria
# use cds-spatial repo from github https://github.com/CDS-AU-DK/cds-spatial
kaz <-brick("../1_Teaching/cds-spatial/data/Kaz.tif")
plotRGB(kaz, stretch= "lin")
crs(kaz)
```

### Prediction data

```{r predi-data}
# Load prediction data as points (left bottom corner of the evaluated cell)
cnne_df <- read_csv("2021-10-25.predictions/results/east/east.csv")
# 15334 points (origins in the raster cells)
cnnw_df <- read_csv("2021-10-25.predictions/results/west/west.csv")
# 15334 points (origins in the raster cells)
cnn_df <- rbind(cnne_df, cnnw_df)
# 30504 rows

# Check the probabilities of there being a mound in a given cell
hist(cnn_df$mound_probability,
        main = "Probability of mound present in a satellite image gridcell");abline(v=0.6, col="red", lty = 2, lwd = 3)
table(cut(cnn_df$mound_probability, c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)))

# ok, so there is an exponential drop-off. 
```
### Make the predictions spatial and convert to grid

```{r predi-spatial}

### Build a grid of those with 60%+ probability of containing a mound

# Build a grid from all points
#cnnall_sp <- st_as_sf(cnn_df, coords = c("x","y"), crs = 32635)
#cnnall_grid <- st_make_grid(cnnall_sp, cellsize = 250, what = "polygons")

# Filter predictions to those that have 60+% likelihood of containing a mound
cnn60_sp <- cnn_df %>% 
  filter(mound_probability > 0.59) %>%  #333 observations
  st_as_sf(coords = c("x","y"), crs = 32635)

# Make a grid of 60%+ cells
cnn_grid <- st_make_grid(cnn60_sp, cellsize = 250, what = "polygons")
plot(cnn_grid)

# Add probability data to the 60%+ grid 
#cnnall_datagrid <- st_join(st_sf(cnnall_grid), cnnall_sp)
cnn_grid <- st_join(st_sf(cnn_grid), cnn60_sp)

# Visualize the grid cells with higher probability 
ggplot(cnn_grid) +
  geom_sf(aes(color = mound_probability))

# 333 raster cells are predicted to contain mounds with greater 
# than 60% likelihood. Archaeologists found 773 mounds in fraction of the area

# View the grid 
plotRGB(kaz, stretch= "lin");
plot(cnn_grid$geometry, add = TRUE, border = "white")
```


### Field data

that we will need later for validation

```{r field-data}
# Bring in survey area to see overall coverage
survey <- st_read("../1_Teaching/cds-spatial/data/KAZ_surveyarea.shp")
plot(survey$geometry)

# Bring in all the mounds observed in the field
mounds <- st_read("../1_Teaching/cds-spatial/data/KAZ_mounds.shp")
plot(mounds)
```


```{r bounding-boxes}
# Extrapolate rough study area after subtracting outliers
far <- mounds %>% 
  st_is_within_distance(survey, 1500) %>% 
  lengths>0 
farmounds <- which(far==0)  # these are the mounds that are mostly far from survey area

# convex hull of points without outliers
survey_sm <- st_convex_hull(st_union(mounds$geometry[-farmounds]))

# convex hull of survey polygons 
survey_ch <- st_convex_hull(st_union(survey$geometry))

# quickly see the difference in bounding boxes
plot(survey_ch, col = "green");plot(survey_sm, col = "red", alpha=0.5, add = TRUE); plot(survey$geometry, add =TRUE)

```



### Plot the basic data
```{r view}
# View all mounds
plotRGB(kaz, stretch= "lin");
plot(survey_ch, col = "green", add = TRUE);
plot(survey_sm, col = "red", add = TRUE);
plot(survey$geometry, col = "lightyellow", add = TRUE );
plot(mounds$geometry[-farmounds,], add = TRUE, col = "pink");
plot(cnn_grid$geometry, add = TRUE, border = "white")


```

## Validation - Overlap with Field Data

Area surveyed in 2009-2011 is ca 85 sq km and contains 773 documented mounds of various shapes and sizes. This area contains 192 grid cells of 250m a side which were allocated 0.6+ probability of containing a mound.
Let's explore how many mounds are outside these grid cells and which mounds were predicted and which not. Bring in mound attributes and check correlation. Does size play a role?

```{r mound-attributes}
# Bring in mound attributes (n = 773) to aid exploration
mounddata <- read_csv("../1_Teaching/cds-spatial/data/KAZ_mdata.csv")
mounds <- mounds %>% 
  left_join(mounddata, by = c("TRAP_Code"="MoundID"))
```

```{r select-grids}
# Select gridcells that fall within TRAP study area

survey_grids <- st_intersection(survey_ch, cnn_grid)
plot(survey_grids)
```

```{r overlap}
# Check spatial overlap between 60%+ grid cells and all 773 mounds 
predicted <- st_intersection(mounds, cnn_grid) 

# Which ones areun-predicted? 
`%nin%` = Negate(`%in%`)
unpredicted <- mounds[mounds$TRAP_Code%nin%predicted$TRAP_Code,]

predicted #166 unique features here
unique(predicted$TRAP_Code) # 144 unique mounds
unique(cnn_grid$X1) #332 unique cells

# 146 unique mounds (of 166 intersecting) appear in the 332 unique (of 380) grids




grids_n_mounds <- predicted %>% 
#  st_drop_geometry() %>% 
  group_by(X1) %>% 
  count()

hist(grids_n_mounds$n, breaks = 40)

grids_n_mounds %>% 
  filter(n>2)
# Gridcells contain between 0 and 29 mounds, which makes sense for the necropolis of little 10m diameter mounds in the NW
```

## Visualize results 
```{r mapview}
# See the predicted mounds over grids with 60% likelihood of mound plus unpredicted mounds

library(mapview)
mapview(unpredicted, color = "orange", alpha= 0.5,
         map.types = c("Esri.WorldImagery", "CartoDB.Positron"))+
  mapview(grids_n_mounds, zcol = "n", at = c(1, 2, 5, 10, 15, 30),
          layer.name = " Predicted mounds per grid")+
  survey_grids
```

## Summary of success rates

146 mounds was detected out of 773, making the CNN predictions (over 60% probability) about 20% successful.

```{r}
cnn_grid
```

Look at the NW cluster and see that many mounds sit on the border of polygons, and so get counted twice > ca 20 mounds, so the numbers of predicted are slightly exaggerated
In NE we are missing a lot of very large 20m diameter+ mounds that are covered with scrub (look forested) 
In the south a lot of forest patches and beach boundaries are getting picked up that are false positives
All in all the model seems to pick on the bright signatures rather than round shapes and there is an odd combination of large forested lozenges and small bare spots picked up, but somehow round forested images with little excavated (bright) trenches on the south side is not getting picked up.


## Further exploration - Height
Let's see what other factors impact detectability in the CNN

### Add un/predicted column to mound data
```{r write-pred-status}
# Add the information on prediction to mound dataset
mounds <- mounds %>% 
  mutate(predicted60 =  case_when(TRAP_Code %in% predicted$TRAP_Code ~ "yes",
                                  TRAP_Code %nin% predicted$TRAP_Code ~ "no"
                                  ))

# Look at the predicted and un=predicted mounds 
unpredicted <- mounds[mounds$TRAP_Code%nin%predicted$TRAP_Code,]

plot(unpredicted$geometry, col = "red", main = "Mounds predicted (green) and unpredicted (red) by CNN");plot(predicted$geometry, col = "darkgreen", add= TRUE); 
```



```{r explore-height}
# filter the mounds for largesh and noticeable ones (2+ meters)
large <- mounds %>% 
  filter(Height>=2) # 247 obs

mounds %>% 
  group_by(predicted60) %>% 
  summarize(min = min(Height), max = max(Height))

# Check the height difference between un- and predicted mounds
boxplot(Height~predicted60, data = mounds)

# Check height distribution btw un- and predicted mounds
hist(mounds$Height[mounds$predicted60 == "no"], col = "pink", breaks  = 20);
hist(mounds$Height[mounds$predicted60 == "yes"], col = "yellow", add =TRUE, alpha = 0.5)

```
T-test on height
```{r ttest-height}
# Is there a significant relationship between the Height of a mound and its detection?
t.test(Height ~ as.factor(predicted60), data = mounds)
str(t.test(Height ~ as.factor(predicted60), data = mounds))
# ... the answer seems to be yes with p at 3.14e-05

```




## Side-by-side static visualisations
```{r visualisation}
par(mfrow = c(1,2))

# Look at the predicted and un=predicted mounds 
plotRGB(kaz, stretch= "lin", main = "Predicted vs unpredicted mounds");
plot(mounds$geometry[mounds$predicted60 == "no"], add = TRUE, col = "red")
plot(mounds$geometry[mounds$predicted60 == "yes"], add = TRUE, col = "green")
plot(cnn_grid$geometry, add = TRUE, border = "white")
legend(x = "bottom",          # Position
       legend = c("undetected", "detected",
                  "grids with 60%+ mound probability"),  # Legend texts
       pch = c(1,1,0),       # Symbol shapes
       col = c("red","green", "lightgrey"))           # Line colors
     

# View Large mounds only
plotRGB(kaz, stretch= "lin", main = "Un/Predicted mounds of 2m+ height");
plot(mounds$geometry[mounds$predicted60 == "no" & mounds$Height >=2], add = TRUE, col = "red")
plot(mounds$geometry[mounds$predicted60 == "yes"& mounds$Height >=2], add = TRUE, col = "green")
plot(cnn_grid$geometry, add = TRUE, border = "white")
legend(x = "bottom",          # Position
       legend = c("unpredicted 2m+ mounds", "predicted 2m+ mounds",
                  "grids with 60%+ mound probability"),  # Legend texts
       pch = c(1,1,0),       # Symbol shapes
       col = c("red","green", "lightgrey"))           # Line colors
     
```


```{r viz-mounds-size}
# See the predicted 146/166 mound features of all sizes 
cnn_grid %>% 
 # filter(mound_probability>0.5) %>% 
  ggplot()+
  geom_sf(aes(color = mound_probability))+
  scale_color_gradient(low = "green", 
                       high = "red",
                       "Mound probability")+
  geom_sf(data = mounds$geometry[mounds$predicted60 == "yes"], size = mounds$Height[mounds$predicted60 == "yes"], col = "lightgrey", alpha = 0.5) +
  ggtitle("Predicted mounds in Kazanlak")

# See the unpredicted 627 mounds 
cnn_grid %>% 
  # filter(mound_probability>0.5) %>% 
  ggplot()+
  geom_sf(aes(color = mound_probability))+
  scale_color_gradient(low = "green", 
                       high = "red",
                       "Mound probability")+
  #geom_sf(data = unpredicted$geometry)+
  geom_sf(data = mounds$geometry[mounds$predicted60 == "no"], size = mounds$Height[mounds$predicted60 == "no"], col = "lightgrey", alpha = 0.5)
  ggtitle("unpredicted mounds in Kazanlak")
```
## Other factors?? To be continued, ... 

Differentiate predictions by other criteria - perhaps RS dataset visibility in 2001 IKONOS?

Create a segregated density image of mound presence?

Biggest ommisions  (false negatives) appear in NE where large mounds are present and biggest overcommits (false positives) are south of the reservoir, where there are morphological features but few mounds.

## Need better training data?

Let's filter the mounds to the large and visible ones, and prepare cutouts so they can be run through the model and see if the detection rate improves.
First I create the loop to produce squares/grids to use to cutout segments from the raster, then I need to figure out by what characteristics I best improve the model (e.g. get those large scrubby mounds from NE)
```{r mound-grids-polys}

radius <- 75
mounds$northing <- st_coordinates(mounds)[,2]
mounds$easting <- st_coordinates(mounds)[,1]


# define the plot edges based upon the plot radius. 

yPlus <- mounds$northing+radius
xPlus <- mounds$easting+radius
yMinus <- mounds$northing-radius
xMinus <- mounds$easting-radius

# calculate polygon coordinates for each plot centroid. 
square <- cbind(xMinus,yPlus,  # NW corner
	xPlus, yPlus,  # NE corner
	xPlus,yMinus,  # SE corner
	xMinus,yMinus, # SW corner
	xMinus,yPlus)  # NW corner again - close ploygon

# Extract the mound ID information
ID <- mounds$TRAP_Code

# create spatial polygons from coordinates with mapply
polys <- SpatialPolygons(mapply(function(poly, id) 
		{
	  xy <- matrix(poly, ncol=2, byrow=TRUE)
	  Polygons(list(Polygon(xy)), ID=id)
	  }, 
	split(square, row(square)), ID),
	proj4string=CRS(as.character("+proj=utm +zone=35 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")))

plot(polys)


mnd_polys <- st_as_sf(polys)
plot(mnd_polys$geometry)
mnd_polys$geometry


# Convert to sf feature
polys_df <- SpatialPolygonsDataFrame(polys, data.frame(id=ID, row.names=ID))
polys_df
mnd_polys <- st_as_sf(polys_df)
mnd_polys

# Add attributes
mnd_poly <- mnd_polys %>% 
  left_join(mounddata, by = c("id"="MoundID"))

# Write to shapefile
st_write(mnd_poly, "data/moundpolys140.shp",driver = 'ESRI Shapefile')


mnd_poly2 <- mnd_poly %>% 
  filter(Height>=2) 


# Loop over a sample of largish mounds and cutout postage stamp rasters
randomID <- mnd_poly2$id%>% 
  sample(size = 25, replace = FALSE)
unique(randomID)

 # cutouts per sample number
for (i in randomID){
  new_clip <- crop(kaz, mnd_poly[mnd_poly$id ==i,])
  plotRGB(new_clip)
  writeRaster(new_clip, filename= paste0("data/",i,".tiff"), format = "GTiff", overwrite =TRUE)
}

# Works only if there is overlap with the raster! Nonoverlapping don't work so well:
mnd_poly[mnd_poly$id ==2006,]
i = 2006

# Check for overlap with the satellite image
```


```{r generate--slowly-stamps-that-overlap-raster}
# Check spatial overlap
#https://gis.stackexchange.com/questions/34535/detect-whether-there-is-a-spatial-polygon-in-a-spatial-extent
# in <- intersect(e, extent(sp))
# if (isTRUE(in)) { in <- gIntersects(as(e, 'SpatialPolygons'), sp) }

library(rgeos)

for (i in randomID){
  lapply(poly, function(raster) {
    poly <- as(mnd_poly[mnd_poly$id ==i,], "Spatial")
    ei <- as(extent(kaz), "SpatialPolygons")
    if (gContainsProperly(ei,poly)) {
      paste0(i," is fully within")
      new_clip <- crop(kaz, mnd_poly[mnd_poly$id ==i,])
      plotRGB(new_clip)
      writeRaster(new_clip, 
                  filename= paste0("data/",i,".tiff"), 
                  format = "GTiff", overwrite =TRUE)
  } else if (gIntersects(ei,poly)) {
    paste0(i," intersects")
  } else {
    paste0(i," is fully outside the raster")
  }
})
}

# This works, but stamps are pixellated. Higher resolution is needed

randomID
new_clip
```

